# Default shell library for eimg utils.
# Copyright (C) 2015 Red Hat, Inc.
# Written by Pavel Raiskup.
#
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License as published by the Free Software Foundation; either
# version 2.1 of the License, or (at your option) any later version.
#
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public
# License along with this library; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA

eimg_info ()
{
    echo >&2 " * $*"
}

eimg_error ()
{
    echo >&2 " ! $*"
}

eimg_die ()
{
    eimg_error "$*"
    exit 1
}

distgen_stdin_template ()
{
    _eimg_tmp=`mktemp /tmp/dg-workaround-XXXXX`
    test -z "$_eimg_tmp" && eimg_die "can't create temp file"

    cat > "$_eimg_tmp"

    ${DG-dg} --distro "${eimg_distro-fedora-rawhide-x86_64}.yaml" --template "$_eimg_tmp"
}

eimg_pkg_manager ()
{
    eimg_pkg_manager_result=`distgen_stdin_template <<<"{{ commands.pkginstaller.binary }}"`
}

eimg_generate_passwd ()
{
    eimg_generate_passwd_result=`openssl passwd -1 "$1"`
    test -z "$eimg_generate_passwd_result" && die "can't generate passwd"
}

eimg_remote_run ()
{
    local cmd="$1"
    echo "running: $cmd"
    @insecure_ssh@ root@@pi_exp_host@ "$cmd"
}
