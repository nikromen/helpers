#! /bin/bash

# Prepare Fedora Cloud image for eimg-update.
# Copyright (C) 2015 Red Hat, Inc.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.


opt_image="$1"

dir=$(mktemp -d "/tmp/$(id -n -u)-eimg-XXXXXX")
test -z "$dir" && exit 1
echo "using $dir"

${DG-dg} --distro "${eimg_distro-fedora-rawhide-x86_64}.yaml" \
    --template "@eimgtemplates@/keep-one-kernel.tpl" \
    --output "$dir/eimg-keep-one-kernel" \
  || exit 1

chmod +x "$dir/eimg-keep-one-kernel" || exit 1

guestfish <<EOF
add $opt_image
run
mount /dev/sda1 /
copy-out /etc/ssh/sshd_config $dir
!sed -i -e "s/^PasswordAuthentication.*/PasswordAuthentication yes/" -e "s/#\\?PermitRootLogin.*/PermitRootLogin yes/" $dir/sshd_config
copy-in $dir/sshd_config /etc/ssh
chown 0 0 /etc/ssh/sshd_config
chmod 0600 /etc/ssh/sshd_config
mkdir-p /root/.ssh
!@libexecdir@/eimg-gen-auth-keys $dir/authorized_keys

copy-in $dir/eimg-keep-one-kernel /usr/bin

# authorized keys
copy-in $dir/authorized_keys /root/.ssh
chown 0 0 /root/.ssh/authorized_keys
chmod 0600 /root/.ssh/authorized_keys

# etc shadow
copy-out /etc/shadow $dir
!@libexecdir@/eimg-fix-shadow $dir/shadow
copy-in $dir/shadow /etc
chmod 0000 /etc/shadow
chown 0 0 /etc/shadow

# cloud-init config
copy-out /etc/cloud/cloud.cfg $dir
!@libexecdir@/eimg-fix-cloud-init $dir/cloud.cfg
copy-in $dir/cloud.cfg /etc/cloud
chown 0 0 /etc/cloud/cloud.cfg
chmod 0644 /etc/cloud/cloud.cfg

touch /.autorelabel
EOF
